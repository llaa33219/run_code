<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>C++ Code Executor Terminal</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: monospace;
    }
    /* 터미널 스타일 */
    #terminal {
      background-color: #000;
      color: #0f0;
      padding: 10px;
      height: 100%;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    /* 코드 및 표준입력 폼 스타일 */
    #inputForm {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 10px;
      box-sizing: border-box;
    }
    #codeInput, #stdinInput {
      width: 100%;
      font-family: monospace;
      font-size: 14px;
      padding: 10px;
      margin-bottom: 10px;
      resize: none;
    }
    /* 코드 입력창은 높이를 좀 크게 */
    #codeInput {
      height: 60%;
    }
    /* 표준 입력창은 높이를 적당히 */
    #stdinInput {
      height: 20%;
    }
    #runButton {
      padding: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="content"></div>
  
  <script>
    (function() {
      // Unicode 문자열을 안전하게 base64로 인코딩하는 함수
      function base64EncodeUnicode(str) {
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
          return String.fromCharCode('0x' + p1);
        }));
      }
      
      // base64를 Unicode 문자열로 안전하게 디코딩하는 함수
      function base64DecodeUnicode(str) {
        return decodeURIComponent(atob(str).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
      }
      
      // 터미널 인터페이스 생성 함수
      function showTerminal(initialText) {
        var contentDiv = document.getElementById("content");
        contentDiv.innerHTML = "";
        var terminal = document.createElement("div");
        terminal.id = "terminal";
        terminal.textContent = initialText || "";
        contentDiv.appendChild(terminal);
        return terminal;
      }
      
      // C++ 코드를 실행하는 함수 (Piston API 사용)
      function runCppCode(code, stdin) {
        var terminal = showTerminal("코드를 실행 중입니다...\n\n");
        fetch("https://emkc.org/api/v2/piston/execute", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            language: "cpp",
            version: "10.2.0",
            files: [{
              name: "main.cpp",
              content: code
            }],
            stdin: stdin
          })
        })
        .then(function(response) {
          if (!response.ok) {
            return response.json().then(errData => {
              throw new Error("API 요청 중 오류가 발생했습니다. 상태 코드: " + response.status + " 메시지: " + JSON.stringify(errData));
            });
          }
          return response.json();
        })
        .then(function(data) {
          var output = "";
          if (data.run) {
            if (data.run.stdout) {
              output += "출력:\n" + data.run.stdout + "\n";
            }
            if (data.run.stderr) {
              output += "에러:\n" + data.run.stderr + "\n";
            }
            output += "종료 코드: " + data.run.exitCode;
          } else {
            output = "실행 결과를 가져올 수 없습니다.";
          }
          terminal.textContent = output;
        })
        .catch(function(error) {
          terminal.textContent = "코드 실행 중 에러가 발생했습니다: " + error;
        });
      }
      
      // 코드 및 표준입력을 입력받는 폼 생성 함수
      function showInputForm() {
        var contentDiv = document.getElementById("content");
        contentDiv.innerHTML = "";
        var form = document.createElement("form");
        form.id = "inputForm";
        form.onsubmit = function(event) {
          event.preventDefault();
          var code = document.getElementById("codeInput").value;
          var stdin = document.getElementById("stdinInput").value;
          if(code.trim() === "") return;
          var payloadObj = {
            code: code,
            stdin: stdin
          };
          var encoded;
          try {
            encoded = base64EncodeUnicode(JSON.stringify(payloadObj));
          } catch (e) {
            alert("인코딩 중 에러가 발생했습니다: " + e);
            return;
          }
          // URL을 현재 도메인과 경로를 유지하면서 ?= 뒤에 인코딩된 JSON을 추가
          window.location.href = window.location.origin + window.location.pathname + "?=" + encodeURIComponent(encoded);
        };
        
        var codeTextarea = document.createElement("textarea");
        codeTextarea.id = "codeInput";
        codeTextarea.placeholder = "여기에 C++ 코드를 입력하세요.";
        form.appendChild(codeTextarea);
        
        var stdinTextarea = document.createElement("textarea");
        stdinTextarea.id = "stdinInput";
        stdinTextarea.placeholder = "여기에 표준 입력을 입력하세요. (Optional)";
        form.appendChild(stdinTextarea);
        
        var button = document.createElement("button");
        button.id = "runButton";
        button.type = "submit";
        button.textContent = "실행";
        form.appendChild(button);
        
        contentDiv.appendChild(form);
      }
      
      // URL에 ?=가 있으면 base64 디코딩 후 JSON 파싱하여 코드와 표준입력 추출, 그렇지 않으면 입력폼 표시
      var search = window.location.search;
      if (search && search.indexOf("?=") === 0) {
        var encodedPart = decodeURIComponent(search.substring(2));
        var payloadObj;
        try {
          payloadObj = JSON.parse(base64DecodeUnicode(encodedPart));
        } catch (e) {
          // 만약 JSON 파싱에 실패하면, 단순 코드로 간주
          payloadObj = { code: base64DecodeUnicode(encodedPart), stdin: "" };
        }
        runCppCode(payloadObj.code, payloadObj.stdin);
      } else {
        showInputForm();
      }
    })();
  </script>
</body>
</html>
