<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>C++ Code Executor Terminal</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: monospace;
    }
    /* 터미널 스타일 */
    #terminal {
      background-color: #000;
      color: #0f0;
      padding: 10px;
      height: 100%;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    /* 코드 입력 폼 스타일 */
    #inputForm {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 10px;
      box-sizing: border-box;
    }
    textarea {
      width: 100%;
      font-family: monospace;
      font-size: 14px;
      padding: 10px;
      resize: vertical;
      margin-bottom: 10px;
    }
    /* 코드 입력창과 표준 입력창 높이 비율 조정 */
    #codeInput {
      height: 40%;
    }
    #stdinInput {
      height: 20%;
    }
    #runButton {
      padding: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="content"></div>
  
  <script>
    (function() {
      // Unicode 문자열을 안전하게 base64로 인코딩하는 함수
      function base64EncodeUnicode(str) {
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
          return String.fromCharCode('0x' + p1);
        }));
      }
      
      // base64를 Unicode 문자열로 안전하게 디코딩하는 함수
      function base64DecodeUnicode(str) {
        return decodeURIComponent(atob(str).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
      }
      
      // 터미널 인터페이스 생성 함수
      function showTerminal(initialText) {
        var contentDiv = document.getElementById("content");
        contentDiv.innerHTML = "";
        var terminal = document.createElement("div");
        terminal.id = "terminal";
        terminal.textContent = initialText || "";
        contentDiv.appendChild(terminal);
        return terminal;
      }
      
      // C++ 코드를 실행하는 함수 (Piston API 사용)
      // 두번째 매개변수 stdin은 프로그램이 실행될 때 전달할 표준 입력값입니다.
      function runCppCode(code, stdin) {
        var terminal = showTerminal("코드를 실행 중입니다...\n\n");
        fetch("https://emkc.org/api/v2/piston/execute", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            language: "cpp",
            version: "10.2.0",
            files: [{
              name: "main.cpp",
              content: code
            }],
            stdin: stdin || ""
          })
        })
        .then(function(response) {
          if (!response.ok) {
            return response.json().then(errData => {
              throw new Error("API 요청 중 오류가 발생했습니다. 상태 코드: " + response.status + " 메시지: " + JSON.stringify(errData));
            });
          }
          return response.json();
        })
        .then(function(data) {
          var output = "";
          if (data.run) {
            if (data.run.stdout) {
              output += "출력:\n" + data.run.stdout + "\n";
            }
            if (data.run.stderr) {
              output += "에러:\n" + data.run.stderr + "\n";
            }
            output += "종료 코드: " + data.run.exitCode;
          } else {
            output = "실행 결과를 가져올 수 없습니다.";
          }
          terminal.textContent = output;
        })
        .catch(function(error) {
          terminal.textContent = "코드 실행 중 에러가 발생했습니다: " + error;
        });
      }
      
      // 코드 입력 폼 생성 함수
      // 여기서는 C++ 코드와 프로그램 실행 시 사용할 표준 입력값을 입력할 수 있는 두 개의 입력창을 제공합니다.
      function showInputForm() {
        var contentDiv = document.getElementById("content");
        contentDiv.innerHTML = "";
        var form = document.createElement("form");
        form.id = "inputForm";
        form.onsubmit = function(event) {
          event.preventDefault();
          var code = document.getElementById("codeInput").value;
          var stdin = document.getElementById("stdinInput").value;
          if (code.trim() === "") return;
          // code와 stdin을 하나의 JSON 객체로 묶어 base64 인코딩
          var payload = { code: code, stdin: stdin };
          var encoded;
          try {
            encoded = base64EncodeUnicode(JSON.stringify(payload));
          } catch (e) {
            alert("인코딩 중 에러가 발생했습니다: " + e);
            return;
          }
          // 현재 URL의 도메인과 경로는 그대로 두고, 쿼리스트링에 ?= 인코딩된 JSON 문자열을 추가합니다.
          window.location.href = window.location.origin + window.location.pathname + "?=" + encodeURIComponent(encoded);
        };
        
        var codeTextarea = document.createElement("textarea");
        codeTextarea.id = "codeInput";
        codeTextarea.placeholder = "여기에 C++ 코드를 입력하세요.";
        form.appendChild(codeTextarea);
        
        var stdinTextarea = document.createElement("textarea");
        stdinTextarea.id = "stdinInput";
        stdinTextarea.placeholder = "프로그램 입력값 (옵션)";
        form.appendChild(stdinTextarea);
        
        var button = document.createElement("button");
        button.id = "runButton";
        button.type = "submit";
        button.textContent = "실행";
        form.appendChild(button);
        
        contentDiv.appendChild(form);
        // 코드 입력창에 자동 포커스를 줍니다.
        codeTextarea.focus();
      }
      
      // 페이지 초기화: URL의 쿼리스트링이 "?="로 시작하면 base64 디코딩 후 실행,
      // 그렇지 않으면 코드/입력값을 입력할 폼을 표시합니다.
      var search = window.location.search;
      if (search && search.indexOf("?=") === 0) {
        var encodedPart = decodeURIComponent(search.substring(2));
        var decoded;
        try {
          decoded = base64DecodeUnicode(encodedPart);
        } catch (e) {
          showTerminal("base64 디코딩 중 에러가 발생했습니다: " + e);
          return;
        }
        var code = "";
        var stdin = "";
        try {
          var payload = JSON.parse(decoded);
          code = payload.code;
          stdin = payload.stdin;
        } catch(e) {
          // JSON 파싱 실패 시, 전체 디코딩된 텍스트를 코드로 처리합니다.
          code = decoded;
          stdin = "";
        }
        runCppCode(code, stdin);
      } else {
        showInputForm();
      }
    })();
  </script>
</body>
</html>
