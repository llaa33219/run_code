<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>C++ Interactive Terminal Executor</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: monospace;
      background-color: #000;
      color: #0f0;
    }
    /* 인터랙티브 터미널 전체 영역 */
    #terminalContainer {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    /* 터미널 출력 영역 */
    #terminal {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      white-space: pre-wrap;
      background-color: #000;
      color: #0f0;
    }
    /* 입력 영역 (터미널 하단) */
    #inputArea {
      border-top: 1px solid #0f0;
      padding: 10px;
      display: flex;
    }
    #inputField {
      flex: 1;
      background: #000;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 5px;
      font-family: monospace;
      font-size: 16px;
    }
    #submitButton, #resetButton {
      background: #0f0;
      color: #000;
      border: none;
      padding: 5px 10px;
      margin-left: 10px;
      cursor: pointer;
      font-size: 16px;
    }
    /* 초기 코드/입력값 입력 폼 */
    #inputForm {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 20px;
      box-sizing: border-box;
      background-color: #000;
      color: #0f0;
    }
    #codeInput, #stdinInput {
      width: 100%;
      font-family: monospace;
      font-size: 14px;
      padding: 10px;
      margin-bottom: 10px;
      resize: none;
      background: #000;
      color: #0f0;
      border: 1px solid #0f0;
      box-sizing: border-box;
    }
    #codeInput {
      height: 50%;
    }
    #stdinInput {
      height: 20%;
    }
    #runButton {
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      background: #0f0;
      color: #000;
      border: none;
    }
  </style>
</head>
<body>
  <div id="content"></div>
  
  <script>
    (function() {
      // Base64 인코딩/디코딩 (Unicode 안전)
      function base64EncodeUnicode(str) {
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
          function(match, p1) {
            return String.fromCharCode('0x' + p1);
          }
        ));
      }
      function base64DecodeUnicode(str) {
        return decodeURIComponent(atob(str).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
      }
      
      // 전역 변수: C++ 코드와 현재까지의 표준 입력 누적
      var code = "";
      var stdinBuffer = "";
      
      // Piston API를 이용하여 C++ 코드를 실행하는 함수  
      // (주의: Piston API는 진정한 인터랙티브 실행을 지원하지 않으므로,
      //  사용자가 입력한 모든 내용을 STDIN으로 전달하여 프로그램을 새로 실행합니다.)
      function runCpp(code, stdinBuffer) {
        var terminal = document.getElementById("terminal");
        terminal.textContent = "실행 중입니다...\n";
        fetch("https://emkc.org/api/v2/piston/execute", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            language: "cpp",
            version: "10.2.0",
            files: [{ name: "main.cpp", content: code }],
            stdin: stdinBuffer
          })
        })
        .then(function(response) {
          if (!response.ok) {
            return response.json().then(errData => {
              throw new Error("API 요청 오류: 상태 " + response.status + " 메시지: " + JSON.stringify(errData));
            });
          }
          return response.json();
        })
        .then(function(data) {
          var output = "";
          if (data.run) {
            if (data.run.stdout) {
              output += data.run.stdout;
            }
            if (data.run.stderr) {
              output += data.run.stderr;
            }
            output += "\n종료 코드: " + data.run.exitCode;
          } else {
            output = "실행 결과를 가져올 수 없습니다.";
          }
          terminal.textContent = output;
          terminal.scrollTop = terminal.scrollHeight;
        })
        .catch(function(error) {
          document.getElementById("terminal").textContent = "실행 중 에러 발생: " + error;
        });
      }
      
      // 인터랙티브 터미널 UI를 구성하는 함수
      function showInteractiveTerminal() {
        var contentDiv = document.getElementById("content");
        contentDiv.innerHTML = "";
        
        var container = document.createElement("div");
        container.id = "terminalContainer";
        
        var terminal = document.createElement("div");
        terminal.id = "terminal";
        terminal.textContent = "";  // 초기 출력은 빈 상태
        container.appendChild(terminal);
        
        var inputArea = document.createElement("div");
        inputArea.id = "inputArea";
        
        var inputField = document.createElement("input");
        inputField.id = "inputField";
        inputField.type = "text";
        inputField.placeholder = "입력...";
        inputArea.appendChild(inputField);
        
        var submitButton = document.createElement("button");
        submitButton.id = "submitButton";
        submitButton.textContent = "전송";
        inputArea.appendChild(submitButton);
        
        var resetButton = document.createElement("button");
        resetButton.id = "resetButton";
        resetButton.textContent = "터미널 리셋";
        inputArea.appendChild(resetButton);
        
        container.appendChild(inputArea);
        contentDiv.appendChild(container);
        
        // 입력 처리: 사용자가 새 입력을 전송하면, 기존 STDIN에 누적하고 전체 내용을 전달하여 재실행
        function handleInput() {
          var inputText = inputField.value;
          if(inputText === "") return;
          stdinBuffer += inputText + "\n";
          inputField.value = "";
          runCpp(code, stdinBuffer);
        }
        submitButton.addEventListener("click", handleInput);
        inputField.addEventListener("keydown", function(e) {
          if(e.key === "Enter") {
            e.preventDefault();
            handleInput();
          }
        });
        // 터미널 리셋: STDIN 누적을 초기화하고 프로그램을 처음부터 다시 실행
        resetButton.addEventListener("click", function() {
          stdinBuffer = "";
          runCpp(code, stdinBuffer);
        });
        
        // 최초 실행 (초기 STDIN으로 실행)
        runCpp(code, stdinBuffer);
      }
      
      // 초기 코드 및 STDIN 입력 폼을 구성하는 함수
      function showInitialForm() {
        var contentDiv = document.getElementById("content");
        contentDiv.innerHTML = "";
        var form = document.createElement("form");
        form.id = "inputForm";
        form.onsubmit = function(event) {
          event.preventDefault();
          var codeText = document.getElementById("codeInput").value;
          var stdinText = document.getElementById("stdinInput").value;
          if(codeText.trim() === "") return;
          code = codeText;
          stdinBuffer = stdinText;
          var payload = { code: code, stdin: stdinBuffer };
          var encoded;
          try {
            encoded = base64EncodeUnicode(JSON.stringify(payload));
          } catch(e) {
            alert("인코딩 에러: " + e);
            return;
          }
          // URL에 인코딩된 데이터를 기록하여 재접속 시 그대로 유지됨
          window.location.href = window.location.origin + window.location.pathname + "?=" + encodeURIComponent(encoded);
        };
        
        var codeTextarea = document.createElement("textarea");
        codeTextarea.id = "codeInput";
        codeTextarea.placeholder = "C++ 코드를 입력하세요.";
        form.appendChild(codeTextarea);
        
        var stdinTextarea = document.createElement("textarea");
        stdinTextarea.id = "stdinInput";
        stdinTextarea.placeholder = "초기 표준 입력 (필요시) 입력하세요.";
        form.appendChild(stdinTextarea);
        
        var runButton = document.createElement("button");
        runButton.id = "runButton";
        runButton.type = "submit";
        runButton.textContent = "실행";
        form.appendChild(runButton);
        
        contentDiv.appendChild(form);
      }
      
      // 메인: URL에 인코딩된 데이터가 있으면 인터랙티브 터미널 실행, 없으면 초기 폼 표시
      var search = window.location.search;
      if (search && search.indexOf("?=") === 0) {
        var encodedPart = decodeURIComponent(search.substring(2));
        var payload;
        try {
          payload = JSON.parse(base64DecodeUnicode(encodedPart));
        } catch(e) {
          payload = { code: base64DecodeUnicode(encodedPart), stdin: "" };
        }
        code = payload.code || "";
        stdinBuffer = payload.stdin || "";
        showInteractiveTerminal();
      } else {
        showInitialForm();
      }
    })();
  </script>
</body>
</html>
