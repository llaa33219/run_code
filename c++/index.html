<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Interactive C++ CMD Terminal</title>
  <style>
    body {
      background-color: black;
      color: lime;
      font-family: monospace;
      margin: 0;
      padding: 0;
    }
    /* 인터랙티브 터미널 (CMD와 유사한 UI) */
    #terminalContainer {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 10px;
      box-sizing: border-box;
    }
    #terminalOutput {
      flex: 1;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    #terminalInput {
      display: flex;
      align-items: center;
      border-top: 1px solid lime;
      padding-top: 5px;
    }
    #prompt {
      margin-right: 5px;
    }
    #cmdInput {
      flex: 1;
      background-color: black;
      color: lime;
      border: none;
      outline: none;
      font-family: monospace;
      font-size: 16px;
    }
    /* 초기 코드 입력 폼 (코드 및 초기 표준입력) */
    #inputForm {
      display: flex;
      flex-direction: column;
      padding: 10px;
      box-sizing: border-box;
    }
    #codeInput, #stdinInput {
      width: 100%;
      font-family: monospace;
      font-size: 14px;
      padding: 10px;
      margin-bottom: 10px;
      resize: none;
      box-sizing: border-box;
    }
    #codeInput {
      height: 50vh;
    }
    #stdinInput {
      height: 10vh;
    }
    #runButton {
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="content"></div>
  
  <script>
    (function() {
      // -------------------------
      // Base64 인코딩/디코딩 (Unicode 지원)
      // -------------------------
      function base64EncodeUnicode(str) {
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
          return String.fromCharCode('0x' + p1);
        }));
      }
      function base64DecodeUnicode(str) {
        return decodeURIComponent(atob(str).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
      }
      
      // -------------------------
      // 전역 변수 (C++ 코드, 누적 표준입력, 마지막 출력)
      // -------------------------
      var code = "";           // C++ 코드
      var inputBuffer = "";    // 사용자가 입력한 누적 표준 입력
      var lastOutput = "";     // 이전에 API에서 받은 전체 출력
      
      // -------------------------
      // 인터랙티브 터미널 (CMD와 유사) UI 구성
      // -------------------------
      function setupInteractiveTerminal() {
        var contentDiv = document.getElementById("content");
        contentDiv.innerHTML = "";
        
        var container = document.createElement("div");
        container.id = "terminalContainer";
        
        var outputDiv = document.createElement("div");
        outputDiv.id = "terminalOutput";
        container.appendChild(outputDiv);
        
        var inputDiv = document.createElement("div");
        inputDiv.id = "terminalInput";
        
        var promptSpan = document.createElement("span");
        promptSpan.id = "prompt";
        promptSpan.textContent = "C:\\>";
        inputDiv.appendChild(promptSpan);
        
        var inputField = document.createElement("input");
        inputField.id = "cmdInput";
        inputField.type = "text";
        inputField.autocomplete = "off";
        inputDiv.appendChild(inputField);
        
        container.appendChild(inputDiv);
        contentDiv.appendChild(container);
        
        // 포커스 설정
        inputField.focus();
        
        // 사용자 입력 처리 (Enter키)
        inputField.addEventListener("keydown", function(e) {
          if (e.key === "Enter") {
            var cmd = inputField.value;
            inputField.value = "";
            // CMD에서는 사용자가 입력한 명령어가 에코되어 출력되므로 이를 추가함.
            appendToTerminal("C:\\> " + cmd + "\n");
            // 누적 표준입력에 입력된 명령어를 추가 (개행 포함)
            inputBuffer += cmd + "\n";
            runProgram();
          }
        });
        
        // 최초 실행: 누적 입력이 비어있더라도 프로그램 실행 결과(예: 프롬프트 출력)를 보여줌.
        runProgram();
      }
      
      // 터미널 출력 영역에 텍스트 추가 (스크롤 자동 하단 이동)
      function appendToTerminal(text) {
        var outputDiv = document.getElementById("terminalOutput");
        outputDiv.textContent += text;
        outputDiv.scrollTop = outputDiv.scrollHeight;
      }
      
      // -------------------------
      // Piston API를 이용해 C++ 프로그램 실행 (누적 입력 전달)
      // -------------------------
      function runProgram() {
        fetch("https://emkc.org/api/v2/piston/execute", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            language: "cpp",
            version: "10.2.0",
            files: [{
              name: "main.cpp",
              content: code
            }],
            stdin: inputBuffer
          })
        })
        .then(function(response) {
          if (!response.ok) {
            return response.json().then(errData => {
              throw new Error("API 요청 오류: 상태 " + response.status + " 메시지: " + JSON.stringify(errData));
            });
          }
          return response.json();
        })
        .then(function(data) {
          var newOutput = "";
          if (data.run) {
            if (data.run.stdout) {
              newOutput += data.run.stdout;
            }
            if (data.run.stderr) {
              newOutput += data.run.stderr;
            }
            newOutput += "\n종료 코드: " + data.run.exitCode;
          } else {
            newOutput = "실행 결과를 가져올 수 없습니다.";
          }
          // 누적 출력이 동일한 부분은 제거하고 새롭게 추가된 부분(diff)만 보여줌.
          var diff = "";
          if (newOutput.indexOf(lastOutput) === 0) {
            diff = newOutput.substring(lastOutput.length);
          } else {
            diff = newOutput;
          }
          lastOutput = newOutput;
          appendToTerminal(diff + "\n");
        })
        .catch(function(error) {
          appendToTerminal("\n[실행 중 에러 발생]: " + error + "\n");
        });
      }
      
      // -------------------------
      // 초기 코드 입력 폼 (C++ 코드와 초기 표준입력 입력)
      // -------------------------
      function showInitialInputForm() {
        var contentDiv = document.getElementById("content");
        contentDiv.innerHTML = "";
        var form = document.createElement("form");
        form.id = "inputForm";
        form.onsubmit = function(event) {
          event.preventDefault();
          var codeText = document.getElementById("codeInput").value;
          var stdinText = document.getElementById("stdinInput").value;
          if (codeText.trim() === "") return;
          code = codeText;
          inputBuffer = stdinText;
          lastOutput = "";
          // URL에 JSON 페이로드를 인코딩하여 기록 (새로고침 시에도 동일 상태 유지)
          var payload = { code: code, stdin: inputBuffer };
          var encoded = base64EncodeUnicode(JSON.stringify(payload));
          window.location.href = window.location.origin + window.location.pathname + "?=" + encodeURIComponent(encoded);
        };
        
        var codeTextarea = document.createElement("textarea");
        codeTextarea.id = "codeInput";
        codeTextarea.placeholder = "여기에 C++ 코드를 입력하세요.";
        form.appendChild(codeTextarea);
        
        var stdinTextarea = document.createElement("textarea");
        stdinTextarea.id = "stdinInput";
        stdinTextarea.placeholder = "초기 표준 입력을 입력하세요. (Optional)";
        form.appendChild(stdinTextarea);
        
        var button = document.createElement("button");
        button.id = "runButton";
        button.type = "submit";
        button.textContent = "실행";
        form.appendChild(button);
        
        contentDiv.appendChild(form);
      }
      
      // -------------------------
      // 메인: URL에 인코딩된 데이터가 있으면 인터랙티브 모드, 없으면 초기 입력 폼 표시
      // -------------------------
      var search = window.location.search;
      if (search && search.indexOf("?=") === 0) {
        var encodedPart = decodeURIComponent(search.substring(2));
        var payload;
        try {
          payload = JSON.parse(base64DecodeUnicode(encodedPart));
        } catch (e) {
          payload = { code: base64DecodeUnicode(encodedPart), stdin: "" };
        }
        code = payload.code || "";
        inputBuffer = payload.stdin || "";
        lastOutput = "";
        setupInteractiveTerminal();
      } else {
        showInitialInputForm();
      }
    })();
  </script>
</body>
</html>
