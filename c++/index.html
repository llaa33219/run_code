<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>C++ Code Executor Terminal</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: monospace;
    }
    /* 터미널 스타일 */
    #terminal {
      background-color: #000;
      color: #0f0;
      padding: 10px;
      height: 100%;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    /* 코드 입력 폼 스타일 */
    #inputForm {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 10px;
      box-sizing: border-box;
    }
    #codeInput, #stdinInput {
      width: 100%;
      font-family: monospace;
      font-size: 14px;
      padding: 10px;
      resize: none;
      margin-bottom: 10px;
    }
    #codeInput {
      height: 50%;
    }
    #stdinInput {
      height: 20%;
    }
    #runButton {
      padding: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="content"></div>
  
  <script>
    (function() {
      // Unicode 문자열을 안전하게 base64로 인코딩하는 함수
      function base64EncodeUnicode(str) {
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
          return String.fromCharCode('0x' + p1);
        }));
      }
      
      // base64를 Unicode 문자열로 안전하게 디코딩하는 함수
      function base64DecodeUnicode(str) {
        return decodeURIComponent(atob(str).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
      }
      
      // 터미널 인터페이스 생성
      function showTerminal(initialText) {
        var contentDiv = document.getElementById("content");
        contentDiv.innerHTML = "";
        var terminal = document.createElement("div");
        terminal.id = "terminal";
        terminal.textContent = initialText || "";
        contentDiv.appendChild(terminal);
        return terminal;
      }
      
      // C++ 코드를 실행하는 함수 (Piston API 사용)
      function runCppCode(code, inputData) {
        var terminal = showTerminal("코드를 실행 중입니다...\n\n");
        fetch("https://emkc.org/api/v2/piston/execute", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            language: "cpp",
            version: "10.2.0",
            files: [{
              name: "main.cpp",
              content: code
            }],
            // 만약 사용자가 입력값(stdin)을 제공하지 않으면 기본값 "100"이 전달됩니다.
            stdin: inputData || ""
          })
        })
        .then(function(response) {
          if (!response.ok) {
            return response.json().then(errData => {
              throw new Error("API 요청 중 오류가 발생했습니다. 상태 코드: " + response.status + " 메시지: " + JSON.stringify(errData));
            });
          }
          return response.json();
        })
        .then(function(data) {
          var output = "";
          if (data.run) {
            if (data.run.stdout) {
              output += "출력:\n" + data.run.stdout + "\n";
            }
            if (data.run.stderr) {
              output += "에러:\n" + data.run.stderr + "\n";
            }
            output += "종료 코드: " + data.run.exitCode;
          } else {
            output = "실행 결과를 가져올 수 없습니다.";
          }
          terminal.textContent = output;
        })
        .catch(function(error) {
          terminal.textContent = "코드 실행 중 에러가 발생했습니다: " + error;
        });
      }
      
      // 코드 및 표준 입력(stdin) 값을 입력받는 폼 생성
      function showInputForm() {
        var contentDiv = document.getElementById("content");
        contentDiv.innerHTML = "";
        var form = document.createElement("form");
        form.id = "inputForm";
        form.onsubmit = function(event) {
          event.preventDefault();
          var code = document.getElementById("codeInput").value;
          var stdinValue = document.getElementById("stdinInput").value;
          if (code.trim() === "") return;
          // 사용자가 프로그램 실행 시 제공할 코드와 stdin 값을 JSON 객체로 묶습니다.
          var payload = { code: code, stdin: stdinValue };
          var encoded;
          try {
            encoded = base64EncodeUnicode(JSON.stringify(payload));
          } catch (e) {
            alert("인코딩 중 에러가 발생했습니다: " + e);
            return;
          }
          // 인코딩된 값을 URL의 쿼리스트링에 추가하여 페이지를 재로딩합니다.
          window.location.href = window.location.origin + window.location.pathname + "?=" + encodeURIComponent(encoded);
        };
        
        var codeTextarea = document.createElement("textarea");
        codeTextarea.id = "codeInput";
        codeTextarea.placeholder = "여기에 C++ 코드를 입력하세요.";
        form.appendChild(codeTextarea);
        
        var stdinTextarea = document.createElement("textarea");
        stdinTextarea.id = "stdinInput";
        // 기본값 "100"을 미리 입력해두어, std::cin >> limit 에서 유효한 숫자가 전달되도록 합니다.
        stdinTextarea.value = "100";
        form.appendChild(stdinTextarea);
        
        var button = document.createElement("button");
        button.id = "runButton";
        button.type = "submit";
        button.textContent = "실행";
        form.appendChild(button);
        
        contentDiv.appendChild(form);
      }
      
      // URL 쿼리스트링 확인: ?= 뒤에 오는 base64 인코딩된 값을 디코딩하여 사용합니다.
      var search = window.location.search;
      if (search && search.indexOf("?=") === 0) {
        var encodedPart = decodeURIComponent(search.substring(2));
        var decoded;
        try {
          decoded = base64DecodeUnicode(encodedPart);
        } catch (e) {
          showTerminal("base64 디코딩 중 에러가 발생했습니다: " + e);
          return;
        }
        var code = "";
        var inputData = "";
        try {
          var obj = JSON.parse(decoded);
          if (obj && typeof obj === "object" && "code" in obj) {
            code = obj.code;
            inputData = obj.stdin || "";
          } else {
            code = decoded;
          }
        } catch (err) {
          code = decoded;
        }
        runCppCode(code, inputData);
      } else {
        showInputForm();
      }
    })();
  </script>
</body>
</html>
