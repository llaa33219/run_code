<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>C++ Code Executor Terminal</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: monospace;
    }
    /* 터미널 스타일 */
    #terminal {
      background-color: #000;
      color: #0f0;
      padding: 10px;
      height: 100%;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    /* 코드 입력 폼 스타일 */
    #inputForm {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 10px;
      box-sizing: border-box;
    }
    #codeInput {
      flex: 1;
      width: 100%;
      font-family: monospace;
      font-size: 14px;
      padding: 10px;
      resize: none;
    }
    #runButton {
      margin-top: 10px;
      padding: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="content"></div>
  
  <script>
    (function() {
      // Unicode 문자열을 안전하게 base64로 인코딩하는 함수
      function base64EncodeUnicode(str) {
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
          return String.fromCharCode('0x' + p1);
        }));
      }
      
      // base64를 Unicode 문자열로 안전하게 디코딩하는 함수
      function base64DecodeUnicode(str) {
        return decodeURIComponent(atob(str).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
      }
      
      // 터미널 인터페이스를 생성하는 함수
      function showTerminal(initialText) {
        var contentDiv = document.getElementById("content");
        contentDiv.innerHTML = "";
        var terminal = document.createElement("div");
        terminal.id = "terminal";
        terminal.textContent = initialText || "";
        contentDiv.appendChild(terminal);
        return terminal;
      }
      
      // C++ 코드를 실행하는 함수 (Piston API 사용)
      function runCppCode(code) {
        var terminal = showTerminal("코드를 실행 중입니다...\n\n");
        // 수정: API에 보낼 페이로드의 version을 "17"로 변경하여 올바른 runtime 사용
        fetch("https://emkc.org/api/v2/piston/execute", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            language: "cpp",
            version: "17",
            files: [{
              name: "main.cpp",
              content: code
            }],
            stdin: ""
          })
        })
        .then(function(response) {
          if (!response.ok) {
            return response.json().then(errData => {
              throw new Error("API 요청 중 오류가 발생했습니다. 상태 코드: " + response.status + " 메시지: " + JSON.stringify(errData));
            });
          }
          return response.json();
        })
        .then(function(data) {
          var output = "";
          if (data.run) {
            if (data.run.stdout) {
              output += "출력:\n" + data.run.stdout + "\n";
            }
            if (data.run.stderr) {
              output += "에러:\n" + data.run.stderr + "\n";
            }
            output += "종료 코드: " + data.run.exitCode;
          } else {
            output = "실행 결과를 가져올 수 없습니다.";
          }
          terminal.textContent = output;
        })
        .catch(function(error) {
          terminal.textContent = "코드 실행 중 에러가 발생했습니다: " + error;
        });
      }
      
      // 코드 입력 폼을 생성하는 함수
      function showInputForm() {
        var contentDiv = document.getElementById("content");
        contentDiv.innerHTML = "";
        var form = document.createElement("form");
        form.id = "inputForm";
        form.onsubmit = function(event) {
          event.preventDefault();
          var code = document.getElementById("codeInput").value;
          if(code.trim() === "") return;
          var encoded;
          try {
            encoded = base64EncodeUnicode(code);
          } catch (e) {
            alert("인코딩 중 에러가 발생했습니다: " + e);
            return;
          }
          // 현재 URL의 도메인과 경로는 그대로 두고 쿼리스트링에 ?=base64코드를 추가
          window.location.href = window.location.origin + window.location.pathname + "?=" + encodeURIComponent(encoded);
        };
        
        var textarea = document.createElement("textarea");
        textarea.id = "codeInput";
        textarea.placeholder = "여기에 C++ 코드를 입력하세요.";
        form.appendChild(textarea);
        
        var button = document.createElement("button");
        button.id = "runButton";
        button.type = "submit";
        button.textContent = "실행";
        form.appendChild(button);
        
        contentDiv.appendChild(form);
      }
      
      // URL의 쿼리스트링을 확인하여 ?= 로 시작하면 base64 디코딩 후 코드 실행, 그렇지 않으면 입력폼 표시
      var search = window.location.search;
      if (search && search.indexOf("?=") === 0) {
        // "?=" 뒤에 오는 base64 인코딩된 문자열 추출 (decodeURIComponent로 원본 그대로 복원)
        var encodedPart = decodeURIComponent(search.substring(2));
        var code;
        try {
          code = base64DecodeUnicode(encodedPart);
        } catch (e) {
          showTerminal("base64 디코딩 중 에러가 발생했습니다: " + e);
          return;
        }
        runCppCode(code);
      } else {
        showInputForm();
      }
    })();
  </script>
</body>
</html>
