<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>C 코드 실행기</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: monospace;
      box-sizing: border-box;
    }
    /* 터미널 모드 스타일 */
    .terminal {
      background-color: black;
      color: #00ff00;
      padding: 10px;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-y: auto;
      height: 100%;
    }
    /* 편집 모드 스타일 */
    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 10px;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      font-size: 16px;
      resize: none;
      margin-bottom: 10px;
    }
    .button-container {
      text-align: center;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    // Unicode를 지원하는 Base64 인코딩 함수
    function base64EncodeUnicode(str) {
      return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
        return String.fromCharCode(parseInt(p1, 16));
      }));
    }
    // Unicode를 지원하는 Base64 디코딩 함수
    function base64DecodeUnicode(str) {
      return decodeURIComponent(atob(str).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
    }

    document.addEventListener("DOMContentLoaded", function() {
      const app = document.getElementById("app");
      const query = window.location.search;
      
      // ?=base64 코드가 있을 경우: 터미널 모드로 전환 (수정/실행 버튼 없이 자동 실행)
      if(query.startsWith("?=") && query.length > 2) {
        // 터미널 스타일 적용
        document.body.style.backgroundColor = "black";
        document.body.style.color = "#00ff00";
        app.innerHTML = "";
        const terminal = document.createElement("div");
        terminal.className = "terminal";
        terminal.textContent = "컴파일 중...\n";
        app.appendChild(terminal);
        
        // URL의 base64 인코딩된 코드를 디코딩
        const encodedCode = query.substring(2);
        let code = "";
        try {
          code = base64DecodeUnicode(encodedCode);
        } catch (e) {
          terminal.textContent = "오류: 올바르지 않은 base64 인코딩 문자열입니다.";
          return;
        }
        
        // Piston API를 사용하여 C 코드 컴파일 및 실행 (stdin은 빈 문자열)
        fetch("https://emkc.org/api/v2/piston/execute", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            language: "c",
            version: "latest",
            files: [
              {
                name: "main.c",
                content: code
              }
            ],
            stdin: ""
          })
        })
        .then(response => response.json())
        .then(data => {
          let output = "";
          if(data.compile && data.compile.output) {
            output += data.compile.output;
          }
          if(data.run && data.run.output) {
            output += data.run.output;
          }
          terminal.textContent = output || "실행 결과가 없습니다.";
        })
        .catch(err => {
          terminal.textContent = "오류 발생: " + err;
        });
      
      // 편집 모드: C 코드를 입력하고 ?=base64 형태의 URL로 전환
      } else {
        app.innerHTML = "";
        const container = document.createElement("div");
        container.className = "container";
        
        const textarea = document.createElement("textarea");
        textarea.placeholder = "여기에 C 코드를 입력하세요...";
        container.appendChild(textarea);
        
        const buttonContainer = document.createElement("div");
        buttonContainer.className = "button-container";
        const runButton = document.createElement("button");
        runButton.textContent = "실행";
        runButton.addEventListener("click", function() {
          const code = textarea.value;
          const encoded = base64EncodeUnicode(code);
          const newUrl = window.location.origin + window.location.pathname + "?=" + encoded;
          window.location.href = newUrl;
        });
        buttonContainer.appendChild(runButton);
        container.appendChild(buttonContainer);
        app.appendChild(container);
      }
    });
  </script>
</body>
</html>
