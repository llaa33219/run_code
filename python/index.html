<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Python Code Executor</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #f5f5f5;
    }
    #container {
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    textarea {
      width: 80%;
      height: 60%;
      font-family: monospace;
      font-size: 1em;
      padding: 10px;
      box-sizing: border-box;
    }
    pre {
      width: 80%;
      height: 80%;
      overflow: auto;
      background-color: #e0e0e0;
      padding: 20px;
      box-sizing: border-box;
      font-family: monospace;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
    }
  </style>
  <!-- 원본 pyodide 스크립트 링크 -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.3/full/pyodide.js"></script>
</head>
<body>
  <div id="container"></div>
  <script>
    // Helper functions to encode/decode Unicode to/from Base64
    function b64EncodeUnicode(str) {
      return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
        return String.fromCharCode(parseInt(p1, 16));
      }));
    }
    function b64DecodeUnicode(str) {
      return decodeURIComponent(atob(str).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
    }
    async function main() {
      let pyodide = await loadPyodide();
      
      // Setup dummy modules for unsupported libraries.
      // 여기서는 tkinter 및 그 하위 모듈(파일 대화상자, 메시지박스, 단순 대화상자, 색상 선택기, ttk)과 Flask 등을 모조리 포함합니다.
      await pyodide.runPythonAsync(`
import sys
import types

# --- Dummy implementation for tkinter and all its submodules ---

if "tkinter" not in sys.modules:
    tkinter = types.ModuleType("tkinter")
    def dummy_Tk(*args, **kwargs):
        print("Dummy tkinter.Tk created. (실제 tkinter는 Pyodide에서 지원되지 않습니다.)")
        return object()
    tkinter.Tk = dummy_Tk
    tkinter.mainloop = lambda: print("Dummy tkinter.mainloop called. (실제 tkinter는 Pyodide에서 지원되지 않습니다.)")
    sys.modules["tkinter"] = tkinter
else:
    tkinter = sys.modules["tkinter"]

# Dummy for tkinter.filedialog
if "tkinter.filedialog" not in sys.modules:
    filedialog = types.ModuleType("tkinter.filedialog")
    def dummy_askopenfilename(*args, **kwargs):
        print("Dummy tkinter.filedialog.askopenfilename called. (실제 tkinter.filedialog는 지원되지 않습니다.)")
        return ""
    def dummy_asksaveasfilename(*args, **kwargs):
        print("Dummy tkinter.filedialog.asksaveasfilename called. (실제 tkinter.filedialog는 지원되지 않습니다.)")
        return ""
    def dummy_askdirectory(*args, **kwargs):
        print("Dummy tkinter.filedialog.askdirectory called. (실제 tkinter.filedialog는 지원되지 않습니다.)")
        return ""
    filedialog.askopenfilename = dummy_askopenfilename
    filedialog.asksaveasfilename = dummy_asksaveasfilename
    filedialog.askdirectory = dummy_askdirectory
    sys.modules["tkinter.filedialog"] = filedialog
    tkinter.filedialog = filedialog

# Dummy for tkinter.messagebox
if "tkinter.messagebox" not in sys.modules:
    messagebox = types.ModuleType("tkinter.messagebox")
    def dummy_showinfo(title, message):
        print("Dummy tkinter.messagebox.showinfo called. Title:", title, "Message:", message)
    def dummy_showerror(title, message):
        print("Dummy tkinter.messagebox.showerror called. Title:", title, "Message:", message)
    def dummy_askyesno(title, message):
        print("Dummy tkinter.messagebox.askyesno called. Title:", title, "Message:", message)
        return False
    def dummy_askokcancel(title, message):
        print("Dummy tkinter.messagebox.askokcancel called. Title:", title, "Message:", message)
        return False
    messagebox.showinfo = dummy_showinfo
    messagebox.showerror = dummy_showerror
    messagebox.askyesno = dummy_askyesno
    messagebox.askokcancel = dummy_askokcancel
    sys.modules["tkinter.messagebox"] = messagebox
    tkinter.messagebox = messagebox

# Dummy for tkinter.simpledialog
if "tkinter.simpledialog" not in sys.modules:
    simpledialog = types.ModuleType("tkinter.simpledialog")
    def dummy_askstring(title, prompt, **kwargs):
        print("Dummy tkinter.simpledialog.askstring called. Title:", title, "Prompt:", prompt)
        return ""
    def dummy_askinteger(title, prompt, **kwargs):
        print("Dummy tkinter.simpledialog.askinteger called. Title:", title, "Prompt:", prompt)
        return None
    def dummy_askfloat(title, prompt, **kwargs):
        print("Dummy tkinter.simpledialog.askfloat called. Title:", title, "Prompt:", prompt)
        return None
    simpledialog.askstring = dummy_askstring
    simpledialog.askinteger = dummy_askinteger
    simpledialog.askfloat = dummy_askfloat
    sys.modules["tkinter.simpledialog"] = simpledialog
    tkinter.simpledialog = simpledialog

# Dummy for tkinter.colorchooser
if "tkinter.colorchooser" not in sys.modules:
    colorchooser = types.ModuleType("tkinter.colorchooser")
    def dummy_askcolor(*args, **kwargs):
        print("Dummy tkinter.colorchooser.askcolor called. (실제 tkinter.colorchooser는 지원되지 않습니다.)")
        return ((0, 0, 0), "#000000")
    colorchooser.askcolor = dummy_askcolor
    sys.modules["tkinter.colorchooser"] = colorchooser
    tkinter.colorchooser = colorchooser

# Dummy for tkinter.ttk
if "tkinter.ttk" not in sys.modules:
    ttk = types.ModuleType("tkinter.ttk")
    class DummyWidget:
        def __init__(self, *args, **kwargs):
            print("Dummy ttk widget created. (실제 tkinter.ttk는 지원되지 않습니다.)")
        def pack(self, *args, **kwargs):
            pass
        def grid(self, *args, **kwargs):
            pass
    ttk.Widget = DummyWidget
    ttk.Button = DummyWidget
    ttk.Label = DummyWidget
    ttk.Entry = DummyWidget
    sys.modules["tkinter.ttk"] = ttk
    tkinter.ttk = ttk

# --- Dummy implementation for Flask ---
if "flask" not in sys.modules:
    flask = types.ModuleType("flask")
    class DummyFlask:
        def __init__(self, *args, **kwargs):
            print("Dummy Flask initialized. (실제 Flask는 지원되지 않습니다.)")
        def run(self, *args, **kwargs):
            print("Dummy Flask run. (실제 Flask는 지원되지 않습니다.)")
    flask.Flask = DummyFlask
    sys.modules["flask"] = flask
      `);
      
      var query = window.location.search;
      if (query.startsWith("?=") && query.length > 2) {
        var encoded = query.substring(2);
        var code;
        try {
          code = b64DecodeUnicode(encoded);
        } catch(e) {
          alert("URL에 있는 base64 코드가 올바르지 않습니다. 다시 코드를 입력해주세요.");
          displayInput();
          return;
        }
        displayOutput();
        let outputElement = document.getElementById("output");
        outputElement.textContent = ""; // 출력 영역 초기화

        // JS 함수로 출력 내용 추가
        function writeOutput(s) {
          outputElement.textContent += s;
        }
        // pyodide의 글로벌 네임스페이스에 write_output 함수를 등록
        pyodide.globals.set("write_output", writeOutput);
        // Python 쪽의 sys.stdout, sys.stderr를 JSWriter 클래스로 재정의하여 JS의 writeOutput 함수를 호출하게 함
        await pyodide.runPythonAsync(`
import sys
class JSWriter:
    def write(self, s):
        write_output(s)
    def flush(self):
        pass
sys.stdout = sys.stderr = JSWriter()
        `);
        try {
          // 입력된 Python 코드를 실행
          let result = await pyodide.runPythonAsync(code);
          if (result !== undefined && result !== null) {
            writeOutput("\\n" + result.toString());
          }
        } catch(e) {
          let errorMsg = e.toString();
          writeOutput("\\nError: " + errorMsg);
        }
      } else {
        displayInput();
      }
    }
    // 코드 입력창과 실행 버튼을 표시하는 함수
    function displayInput() {
      var container = document.getElementById("container");
      container.innerHTML =
        '<textarea id="codeInput" placeholder="여기에 Python 코드를 입력하세요"></textarea><br>' +
        '<button id="executeBtn">실행</button>';
      document.getElementById("executeBtn").addEventListener("click", function() {
        var code = document.getElementById("codeInput").value;
        try {
          var encoded = b64EncodeUnicode(code);
        } catch(e) {
          alert("인코딩 중 오류가 발생했습니다: " + e);
          return;
        }
        // 현재 URL의 프로토콜, 호스트, pathname 유지하며 쿼리 스트링에 base64 인코딩된 코드를 추가
        window.location.href = window.location.origin + window.location.pathname + "?=" + encoded;
      });
    }
    // 실행 결과를 보여줄 전체 화면 출력 영역을 표시하는 함수
    function displayOutput() {
      var container = document.getElementById("container");
      container.innerHTML = '<pre id="output"></pre>';
    }
    main();
  </script>
</body>
</html>
