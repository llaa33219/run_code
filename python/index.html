<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Python Code Executor</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #f5f5f5;
    }
    #container {
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    textarea {
      width: 80%;
      height: 60%;
      font-family: monospace;
      font-size: 1em;
      padding: 10px;
      box-sizing: border-box;
    }
    pre {
      width: 80%;
      height: 80%;
      overflow: auto;
      background-color: #e0e0e0;
      padding: 20px;
      box-sizing: border-box;
      font-family: monospace;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
    }
  </style>
  <!-- 원본 pyodide 스크립트 링크 -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.3/full/pyodide.js"></script>
</head>
<body>
  <div id="container"></div>
  <script>
    // Helper functions to encode/decode Unicode to/from Base64
    function b64EncodeUnicode(str) {
      return btoa(
        encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
          return String.fromCharCode(parseInt(p1, 16));
        })
      );
    }
    function b64DecodeUnicode(str) {
      return decodeURIComponent(
        atob(str).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join('')
      );
    }

    // micropip로 설치 가능한 패키지 매핑 (Pure Python)
    // import 이름 : PyPI 패키지명
    const micropipInstallable = {
      "bs4": "beautifulsoup4",
      "beautifulsoup4": "beautifulsoup4",
      "PyPDF2": "PyPDF2",
      "pypdf2": "PyPDF2",
      "docx": "python-docx",
      "python-docx": "python-docx",
      "pytest": "pytest"
    };

    // Pyodide에서 완벽히 동작할 수는 없지만,
    // "대충"이라도 사용 가능한 더미 모듈을 만들어줄 대상
    // (key: 모듈이름, value: 파이썬 코드 문자열)
    // 여기서 더미 모듈 생성 후 -> 아래서 공통 "__getattr__" 방식으로 확장
    const dummyModules = {
      "tensorflow": `
import types, sys

if "tensorflow" not in sys.modules:
    tf_dummy = types.ModuleType("tensorflow")
    def dummy_constant(value):
        print("Dummy tf.constant called with value:", value)
        return value
    tf_dummy.constant = dummy_constant

    # keras 서브모듈도 가짜로 달아줄 수 있음
    keras_mod = types.ModuleType("tensorflow.keras")
    def dummy_sequential(*args, **kwargs):
        print("Dummy keras.Sequential called.")
    keras_mod.Sequential = dummy_sequential
    tf_dummy.keras = keras_mod

    sys.modules["tensorflow"] = tf_dummy
`,
      "torch": `
import types, sys

if "torch" not in sys.modules:
    torch_dummy = types.ModuleType("torch")
    def dummy_tensor(value):
        print("Dummy torch.tensor called with value:", value)
        return value
    torch_dummy.tensor = dummy_tensor
    sys.modules["torch"] = torch_dummy
`,
      "cv2": `
import types, sys

if "cv2" not in sys.modules:
    cv2_dummy = types.ModuleType("cv2")
    def dummy_imread(path):
        print("Dummy cv2.imread called. Path:", path)
        return None
    cv2_dummy.imread = dummy_imread
    sys.modules["cv2"] = cv2_dummy
`,
      "keras": `
import types, sys

if "keras" not in sys.modules:
    keras_dummy = types.ModuleType("keras")
    def dummy_model(*args, **kwargs):
        print("Dummy keras model function called.")
    keras_dummy.Model = dummy_model
    sys.modules["keras"] = keras_dummy
`,
      "flask": `
import types, sys

if "flask" not in sys.modules:
    flask = types.ModuleType("flask")
    class DummyFlask:
        def __init__(self, *args, **kwargs):
            print("Dummy Flask initialized.")
        def run(self, *args, **kwargs):
            print("Dummy Flask run.")
    flask.Flask = DummyFlask
    sys.modules["flask"] = flask
`,
      "django": `
import types, sys

if "django" not in sys.modules:
    django_mod = types.ModuleType("django")
    print("Dummy django module created.")
    sys.modules["django"] = django_mod
`,
      "fastapi": `
import types, sys

if "fastapi" not in sys.modules:
    fa_mod = types.ModuleType("fastapi")
    class DummyFastAPI:
        def __init__(self, *args, **kwargs):
            print("Dummy FastAPI initialized.")
        def get(self, path):
            print("Dummy FastAPI get on", path)
    fa_mod.FastAPI = DummyFastAPI
    sys.modules["fastapi"] = fa_mod
`,
      "selenium": `
import types, sys

if "selenium" not in sys.modules:
    sel = types.ModuleType("selenium")
    print("Dummy selenium module created.")
    sys.modules["selenium"] = sel
`,
      "pygame": `
import types, sys

if "pygame" not in sys.modules:
    pg = types.ModuleType("pygame")
    def dummy_init():
        print("Dummy pygame.init called.")
    pg.init = dummy_init
    sys.modules["pygame"] = pg
`,
      "wx": `
import types, sys

if "wx" not in sys.modules:
    wx_mod = types.ModuleType("wx")
    print("Dummy wxPython module created.")
    sys.modules["wx"] = wx_mod
`,
      "PyQt5": `
import types, sys

if "PyQt5" not in sys.modules:
    pyqt = types.ModuleType("PyQt5")
    print("Dummy PyQt5 module created.")
    sys.modules["PyQt5"] = pyqt
`,
      "sqlalchemy": `
import types, sys

if "sqlalchemy" not in sys.modules:
    sa = types.ModuleType("sqlalchemy")
    print("Dummy sqlalchemy module created.")
    sys.modules["sqlalchemy"] = sa
`,
      "paramiko": `
import types, sys

if "paramiko" not in sys.modules:
    pm = types.ModuleType("paramiko")
    print("Dummy paramiko module created.")
    sys.modules["paramiko"] = pm
`,
      "twisted": `
import types, sys

if "twisted" not in sys.modules:
    tw = types.ModuleType("twisted")
    print("Dummy twisted module created.")
    sys.modules["twisted"] = tw
`,
      "PyInstaller": `
import types, sys

if "PyInstaller" not in sys.modules:
    pi = types.ModuleType("PyInstaller")
    print("Dummy PyInstaller module created.")
    sys.modules["PyInstaller"] = pi
`,
      "cryptography": `
import types, sys

if "cryptography" not in sys.modules:
    cr = types.ModuleType("cryptography")
    print("Dummy cryptography module created.")
    sys.modules["cryptography"] = cr
`
    };

    // tkinter 포함 각종 tkinter 하위 모듈(파일대화상자, 메시지박스, simpledialog, colorchooser, ttk)도
    // 사용자가 import하면 "대충" 동작하도록 만들어줍니다.
    // 이제 tkinter.Button, tkinter.Label 등도 전부 DummyWidget 처리 + __getattr__로 뭘 해도 에러 안 나게 함.
    const dummyTkinter = `
import sys, types

class _AttrSafe:
    """
    모든 속성 접근을 안전하게 처리하는 헬퍼 클래스.
    """
    def __init__(self, name="_AttrSafe"):
        self.__dict__["_dummy_name"] = name

    def __getattr__(self, item):
        def dummy_method(*args, **kwargs):
            print(f"[{self._dummy_name}.{item}] called with args={args}, kwargs={kwargs}")
            return self  # 체인 형식으로 계속 반환
        return dummy_method

    def __setattr__(self, key, value):
        print(f"[{self._dummy_name}] setattr {key}={value}")

class DummyTk(_AttrSafe):
    def __init__(self, *args, **kwargs):
        super().__init__(name="tkinter.Tk")
        print("Dummy tkinter.Tk created. (실제 GUI는 사용할 수 없습니다.)")

class DummyWidget(_AttrSafe):
    def __init__(self, widget_name="tkinter.Widget", *args, **kwargs):
        super().__init__(name=widget_name)
        print(f"Dummy {widget_name} created.")

if "tkinter" not in sys.modules:
    tkinter = types.ModuleType("tkinter")

    # Tk
    tkinter.Tk = DummyTk
    tkinter.mainloop = lambda: print("Dummy tkinter.mainloop called.")

    # 대표적인 위젯들(사용자가 tkinter.Button(...) 식으로 호출할 때)
    tkinter.Button = lambda *a, **kw: DummyWidget("tkinter.Button", *a, **kw)
    tkinter.Label = lambda *a, **kw: DummyWidget("tkinter.Label", *a, **kw)
    tkinter.Frame = lambda *a, **kw: DummyWidget("tkinter.Frame", *a, **kw)
    tkinter.Entry = lambda *a, **kw: DummyWidget("tkinter.Entry", *a, **kw)
    tkinter.LabelFrame = lambda *a, **kw: DummyWidget("tkinter.LabelFrame", *a, **kw)
    tkinter.Checkbutton = lambda *a, **kw: DummyWidget("tkinter.Checkbutton", *a, **kw)
    tkinter.Radiobutton = lambda *a, **kw: DummyWidget("tkinter.Radiobutton", *a, **kw)
    tkinter.Scale = lambda *a, **kw: DummyWidget("tkinter.Scale", *a, **kw)

    # 하위 모듈들
    if "tkinter.filedialog" not in sys.modules:
        filedialog = types.ModuleType("tkinter.filedialog")
        def dummy_askopenfilename(*args, **kwargs):
            print("Dummy askopenfilename called.")
            return ""
        def dummy_asksaveasfilename(*args, **kwargs):
            print("Dummy asksaveasfilename called.")
            return ""
        def dummy_askdirectory(*args, **kwargs):
            print("Dummy askdirectory called.")
            return ""
        filedialog.askopenfilename = dummy_askopenfilename
        filedialog.asksaveasfilename = dummy_asksaveasfilename
        filedialog.askdirectory = dummy_askdirectory
        sys.modules["tkinter.filedialog"] = filedialog
        tkinter.filedialog = filedialog

    if "tkinter.messagebox" not in sys.modules:
        messagebox = types.ModuleType("tkinter.messagebox")
        def dummy_showinfo(title, message):
            print("[messagebox.showinfo]", title, message)
        def dummy_showerror(title, message):
            print("[messagebox.showerror]", title, message)
        def dummy_askyesno(title, message):
            print("[messagebox.askyesno]", title, message)
            return False
        def dummy_askokcancel(title, message):
            print("[messagebox.askokcancel]", title, message)
            return False
        messagebox.showinfo = dummy_showinfo
        messagebox.showerror = dummy_showerror
        messagebox.askyesno = dummy_askyesno
        messagebox.askokcancel = dummy_askokcancel
        sys.modules["tkinter.messagebox"] = messagebox
        tkinter.messagebox = messagebox

    if "tkinter.simpledialog" not in sys.modules:
        simpledialog = types.ModuleType("tkinter.simpledialog")
        def dummy_askstring(title, prompt, **kwargs):
            print("[simpledialog.askstring]", title, prompt)
            return ""
        def dummy_askinteger(title, prompt, **kwargs):
            print("[simpledialog.askinteger]", title, prompt)
            return None
        def dummy_askfloat(title, prompt, **kwargs):
            print("[simpledialog.askfloat]", title, prompt)
            return None
        simpledialog.askstring = dummy_askstring
        simpledialog.askinteger = dummy_askinteger
        simpledialog.askfloat = dummy_askfloat
        sys.modules["tkinter.simpledialog"] = simpledialog
        tkinter.simpledialog = simpledialog

    if "tkinter.colorchooser" not in sys.modules:
        colorchooser = types.ModuleType("tkinter.colorchooser")
        def dummy_askcolor(*args, **kwargs):
            print("Dummy colorchooser.askcolor called.")
            return ((0, 0, 0), "#000000")
        colorchooser.askcolor = dummy_askcolor
        sys.modules["tkinter.colorchooser"] = colorchooser
        tkinter.colorchooser = colorchooser

    if "tkinter.ttk" not in sys.modules:
        ttk = types.ModuleType("tkinter.ttk")
        # ttk도 비슷하게 대응
        ttk.Button = lambda *a, **kw: DummyWidget("tkinter.ttk.Button", *a, **kw)
        ttk.Label = lambda *a, **kw: DummyWidget("tkinter.ttk.Label", *a, **kw)
        ttk.Entry = lambda *a, **kw: DummyWidget("tkinter.ttk.Entry", *a, **kw)
        ttk.Frame = lambda *a, **kw: DummyWidget("tkinter.ttk.Frame", *a, **kw)
        sys.modules["tkinter.ttk"] = ttk
        tkinter.ttk = ttk

    # tkinter 모듈에도 __getattr__로 모든 속성/메서드 자동 dummy 처리
    def _tkinter_getattr(name):
        print(f"[DUMMY] Accessing 'tkinter.{name}'. returning a DummyWidget or DummyTk if needed.")
        # 혹시 모를 다른 속성 접근 -> DummyWidget 생성
        return lambda *a, **kw: DummyWidget(f"tkinter.{name}", *a, **kw)

    setattr(tkinter, "__getattr__", _tkinter_getattr)

    sys.modules["tkinter"] = tkinter
else:
    # 이미 "tkinter"가 sys.modules에 있다면, 사용자가 별도 세팅한 경우일 수도 있으니 패스
    pass
`;

    /*
      _add_fallback_getattr:
      - dummy 모듈에 이미 특정 함수/메서드는 정의되었을 수 있으나,
        사용자가 다른 서브모듈/속성을 호출하면 AttributeError가 날 수 있음.
      - __getattr__을 이용해 "모든 속성 접근"을 자동으로 처리 -> AttributeError 방지
    */
    function _add_fallback_getattr(moduleName) {
      // 파이썬 코드로 __getattr__ 재정의
      return `
def _fallback_getattr(self, attr):
    print(f"[DUMMY] Accessing '${moduleName}.{attr}'. Returning a dummy callable.")
    def _dummy(*args, **kwargs):
        print(f"[DUMMY FUNCTION] ${moduleName}.{attr} called with args={{args}}, kwargs={{kwargs}}")
        return None
    return _dummy

import sys

_mod = sys.modules.get("${moduleName}")
if _mod is not None and not hasattr(_mod, "__getattr__"):
    setattr(_mod, "__getattr__", _fallback_getattr)
`;
    }

    // 사용자가 입력한 Python 코드를 분석하여 import할 라이브러리 목록을 추출하는 간단한 정규식
    function findImports(code) {
      // 예: "import torch", "import tensorflow as tf", "from keras.models import load_model" ...
      // 그룹1 = 첫 번째 모듈명
      const importRegex = /(?:^|\n)\s*(?:from\s+([a-zA-Z0-9_\.]+)\s+import|import\s+([a-zA-Z0-9_\.]+))/g;
      let modules = new Set();
      let match;
      while ((match = importRegex.exec(code)) !== null) {
        // match[1] 또는 match[2] 중에 있는 값이 모듈명
        let modName = match[1] || match[2];
        // 점이 있는 경우(예: "torch.nn")는 최상위 모듈만 추출("torch")
        let topLevel = modName.split(".")[0];
        modules.add(topLevel);
      }
      return [...modules];
    }

    async function main() {
      let pyodide = await loadPyodide();

      var query = window.location.search;
      if (query.startsWith("?=") && query.length > 2) {
        // URL 쿼리에서 코드 복원
        var encoded = query.substring(2);
        var userCode;
        try {
          userCode = b64DecodeUnicode(encoded);
        } catch (e) {
          alert("URL에 있는 base64 코드가 올바르지 않습니다. 다시 코드를 입력해주세요.");
          displayInput();
          return;
        }
        displayOutput();

        let outputElement = document.getElementById("output");
        outputElement.textContent = ""; // 출력 영역 초기화

        // JS -> Py 출력 연결
        function writeOutput(s) {
          outputElement.textContent += s;
        }
        pyodide.globals.set("write_output", writeOutput);

        // stdout / stderr를 JSWriter로 교체
        await pyodide.runPythonAsync(`
import sys
class JSWriter:
    def write(self, s):
        write_output(s)
    def flush(self):
        pass
sys.stdout = JSWriter()
sys.stderr = JSWriter()
`);

        // 1) 사용자가 작성한 코드에서 import 되는 모듈 조사
        let importedModules = findImports(userCode);

        // 2) micropip로 설치해야 할 애들 골라서 설치 (이미 Pyodide에 포함된 numpy/pandas 등은 제외)
        let toInstall = [];
        for (let m of importedModules) {
          if (micropipInstallable[m]) {
            toInstall.push(micropipInstallable[m]);
          }
        }
        if (toInstall.length > 0) {
          try {
            writeOutput("Installing packages: " + toInstall.join(", ") + "\\n");
            await pyodide.runPythonAsync(`
import micropip
import asyncio

async def install_packages(pkgs):
    for pkg in pkgs:
        print(f"Installing {pkg}...")
        await micropip.install(pkg)

asyncio.run(install_packages(${JSON.stringify(toInstall)}))
`);
          } catch (e) {
            writeOutput("\\nError while installing packages: " + e.toString());
          }
        }

        // 3) “더미 모듈”이어야 할 애들 골라서, 간단한 동작을 하는 파이썬 모듈 코드 실행
        let dummyCode = "";
        // tkinter는 import가 하나라도 있으면 전체 하위 모듈까지 정의
        if (importedModules.includes("tkinter")) {
          dummyCode += dummyTkinter + "\n";
        }
        for (let [modName, dummyPy] of Object.entries(dummyModules)) {
          if (importedModules.includes(modName)) {
            dummyCode += dummyPy + "\n";
          }
        }

        // 3-1) “더미 모듈”에 대해서도 __getattr__로 fallback 처리해서 AttributeError 방지
        for (let modName of importedModules) {
          if (modName === "tkinter") {
            // tkinter는 이미 dummyTkinter 내부에서 __getattr__ 붙였으므로 생략
            continue;
          }
          if (dummyModules[modName]) {
            dummyCode += _add_fallback_getattr(modName) + "\n";
          }
        }

        if (dummyCode.trim().length > 0) {
          try {
            await pyodide.runPythonAsync(dummyCode);
          } catch (e) {
            writeOutput("\\nError while creating dummy modules: " + e.toString());
          }
        }

        // 4) 최종적으로 사용자가 작성한 코드 실행
        try {
          let result = await pyodide.runPythonAsync(userCode);
          if (result !== undefined && result !== null) {
            writeOutput("\\n" + result.toString());
          }
        } catch (e) {
          let errorMsg = e.toString();
          writeOutput("\\nError: " + errorMsg);
        }
      } else {
        // 쿼리가 없으면 입력창 표시
        displayInput();
      }
    }

    // 코드 입력창과 실행 버튼을 표시하는 함수
    function displayInput() {
      var container = document.getElementById("container");
      container.innerHTML =
        '<textarea id="codeInput" placeholder="여기에 Python 코드를 입력하세요"></textarea><br>' +
        '<button id="executeBtn">실행</button>';
      document.getElementById("executeBtn").addEventListener("click", function() {
        var code = document.getElementById("codeInput").value;
        try {
          var encoded = b64EncodeUnicode(code);
        } catch(e) {
          alert("인코딩 중 오류가 발생했습니다: " + e);
          return;
        }
        // 현재 URL의 프로토콜, 호스트, pathname 유지하며 쿼리 스트링에 base64 인코딩된 코드를 추가
        window.location.href = window.location.origin + window.location.pathname + "?=" + encoded;
      });
    }

    // 실행 결과를 보여줄 전체 화면 출력 영역을 표시하는 함수
    function displayOutput() {
      var container = document.getElementById("container");
      container.innerHTML = '<pre id="output"></pre>';
    }

    main();
  </script>
</body>
</html>
